<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="keywords" content="Dracula theme" />
  <title>Let's build a container runtime</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: draculapink;
    }
    a:visited {
      color: draculapink;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #6272a4;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #6272a4;  padding-left: 4px; }
    div.sourceCode
      { color: #f8f8f2; background-color: #242630; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #f8f8f2; } /* Normal */
    code span.al { color: #ff5555; font-weight: bold; } /* Alert */
    code span.an { color: #f1fa8c; font-weight: bold; } /* Annotation */
    code span.at { color: #f1fa8c; } /* Attribute */
    code span.bn { color: #bd93f9; } /* BaseN */
    code span.bu { color: #50fa7b; } /* BuiltIn */
    code span.cf { color: #ff79c6; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #f1fa8c; } /* Char */
    code span.cn { color: #bd93f9; } /* Constant */
    code span.co { color: #6272a4; } /* Comment */
    code span.cv { color: #ff79c6; font-weight: bold; } /* CommentVar */
    code span.do { color: #f8f8f2; } /* Documentation */
    code span.dt { color: #8be9fd; } /* DataType */
    code span.dv { color: #bd93f9; } /* DecVal */
    code span.er { color: #ff5555; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #bd93f9; } /* Float */
    code span.fu { color: #50fa7b; } /* Function */
    code span.im { color: #ff79c6; font-weight: bold; } /* Import */
    code span.in { color: #f8f8f2; font-weight: bold; } /* Information */
    code span.kw { color: #ff79c6; font-weight: bold; } /* Keyword */
    code span.op { color: #f8f8f2; } /* Operator */
    code span.ot { color: #f8f8f2; } /* Other */
    code span.pp { color: #ff79c6; } /* Preprocessor */
    code span.sc { color: #f1fa8c; } /* SpecialChar */
    code span.ss { color: #f1fa8c; } /* SpecialString */
    code span.st { color: #f1fa8c; } /* String */
    code span.va { color: #f8f8f2; } /* Variable */
    code span.vs { color: #f1fa8c; } /* VerbatimString */
    code span.wa { color: #ffb86c; font-weight: bold; } /* Warning */
  </style>
  \usepackage{/home/torben/.config/pandoc/draculatheme}
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Let's build a container runtime</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#lets-build-a-container-runtime"
id="toc-lets-build-a-container-runtime">Let’s build a container
runtime</a>
<ul>
<li><a href="#general-todos" id="toc-general-todos">general
TODOs</a></li>
<li><a href="#conventions" id="toc-conventions">conventions</a></li>
<li><a href="#linux-namespaces" id="toc-linux-namespaces">Linux
namespaces</a>
<ul>
<li><a href="#where-is-my-namespace"
id="toc-where-is-my-namespace">where is my namespace</a></li>
<li><a href="#uts-namespace" id="toc-uts-namespace">uts
namespace</a></li>
<li><a href="#pid-namespace" id="toc-pid-namespace">pid
namespace</a></li>
<li><a href="#mount-namespace" id="toc-mount-namespace">mount
namespace</a></li>
<li><a href="#combining-pid-and-mount"
id="toc-combining-pid-and-mount">combining pid and mount</a></li>
<li><a href="#ips-namespace" id="toc-ips-namespace">ips
namespace</a></li>
<li><a href="#net-namespace" id="toc-net-namespace">net
namespace</a></li>
<li><a href="#user-namespaces" id="toc-user-namespaces">user
namespaces</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="lets-build-a-container-runtime">Let’s build a container
runtime</h1>
<h2 id="general-todos">general TODOs</h2>
<p>talk about nsenter earlier</p>
<p>add mount example with usb stick</p>
<h2 id="conventions">conventions</h2>
<p>commands in different namespaces will be shown with the following
notation:</p>
<pre><code>${id/name}&gt; {command}
{output}</code></pre>
<p>if we’re simply using 2 shells ids (0/1) will be used, otherwise
names might be used</p>
<p>I’m using zsh as a default shell, this makes identifying our test
namespaces easier since we’ll be using bash in these.</p>
<h2 id="linux-namespaces">Linux namespaces</h2>
<blockquote>
<p>A namespace wraps a global system resource in an abstraction that
makes it appear to the processes within the namespace that they have
their own isolated instance of the global resource.</p>
<p>Changes to the global resource are visible to other processes that
are members of the namespace, but are invisible to other processes.</p>
<p>One use of namespaces is to implement containers.</p>
</blockquote>
<p>- man page</p>
<p>Since the man-page mentions that processes are bound to namespaces,
we’ll simply believe this and carry on.</p>
<h3 id="where-is-my-namespace">where is my namespace</h3>
<p>Well, let’s assume that information about the namespace our process
is using is probably stored somewhere, we want to have a look at this
ourselves.</p>
<p>On linux, we have our own filesystem (<code>fs</code> from here on
out) for this, it’s called <code>procfs</code> and is usually handily
pre-mounted for us at <code>/proc</code>.</p>
<p>You can also manually mount it at <code>/proc</code> by doing
<code>mount -t proc proc /proc</code> but usually <code>systemd</code>
does this for you.</p>
<h4 id="catch-youre-it"><strong>catch you’re it</strong></h4>
<p>(<code>$$</code> is our current process id (<code>pid</code> in the
rest of the tutorial))</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls /proc/<span class="va">$$</span>/ns</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 cgroup <span class="at">-</span><span class="op">&gt;</span> cgroup:<span class="pp">[</span><span class="ss">4026531835</span><span class="pp">]</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 ipc <span class="at">-</span><span class="op">&gt;</span> ipc:<span class="pp">[</span><span class="ss">4026531839</span><span class="pp">]</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 mnt <span class="at">-</span><span class="op">&gt;</span> mnt:<span class="pp">[</span><span class="ss">4026531841</span><span class="pp">]</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 net <span class="at">-</span><span class="op">&gt;</span> net:<span class="pp">[</span><span class="ss">4026531840</span><span class="pp">]</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 pid <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 pid_for_children <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 time <span class="at">-</span><span class="op">&gt;</span> time:<span class="pp">[</span><span class="ss">4026531834</span><span class="pp">]</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 time_for_children <span class="at">-</span><span class="op">&gt;</span> time:<span class="pp">[</span><span class="ss">4026531834</span><span class="pp">]</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 user <span class="at">-</span><span class="op">&gt;</span> user:<span class="pp">[</span><span class="ss">4026531837</span><span class="pp">]</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 0 torben 10 Mai 15:18 uts <span class="at">-</span><span class="op">&gt;</span> uts:<span class="pp">[</span><span class="ss">4026531838</span><span class="pp">]</span></span></code></pre></div>
<p>there is also <code>/proc/self/</code> which is simply a link to our
<code>/proc/{pid}</code> directory:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-l</span> /proc/ <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;self -&gt;&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span>    0 root             10 Mai 16:46 self <span class="at">-</span><span class="op">&gt;</span> 13929</span></code></pre></div>
<h3 id="uts-namespace">uts namespace</h3>
<p>The <code>uts</code> namespace is probably the least intersting one
but is a good entrypoing for showing a bit about namespaces
capabilities.</p>
<p>Let’s have a look at our hostname</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> hostname</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">torben-xps9320</span></span></code></pre></div>
<h4 id="entering-a-namespace"><strong>entering a namespace</strong></h4>
<p>we can enter one or multiple namespace with <code>unshare</code></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--help</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Usage:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">unshare</span> <span class="pp">[</span><span class="ss">options</span><span class="pp">]</span> [<span class="op">&lt;</span>program<span class="op">&gt;</span> [<span class="op">&lt;</span>argument<span class="op">&gt;</span>...]]<span class="kw">`</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-m,</span> <span class="at">--mount[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]      unshare mounts namespace</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-u,</span> <span class="at">--uts[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]        unshare UTS namespace <span class="er">(</span><span class="fu">hostname</span> etc<span class="kw">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">-i,</span> <span class="at">--ipc[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]        unshare System V IPC namespace</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">-n,</span> <span class="at">--net[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]        unshare network namespace</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">-p,</span> <span class="at">--pid[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]        unshare pid namespace</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-U,</span> <span class="at">--user[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]       unshare user namespace</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">-C,</span> <span class="at">--cgroup[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]     unshare cgroup namespace</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-T,</span> <span class="at">--time[</span><span class="op">=&lt;</span>file<span class="op">&gt;</span>]       unshare time namespace</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span></code></pre></div>
<p>by executing <code>unshare {command}</code> our command will be run
in a new namespace.</p>
<h4 id="back-to-uts"><strong>back to uts</strong></h4>
<p>Following from this we can enter the uts namespace by doing</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> unshare <span class="ex">--uts</span> bash</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I&#39;m in</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> hostname</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">torben-xps9320</span></span></code></pre></div>
<p>Our hostname inside our new uts namespace is still the same because
by default we’re inheriting all values from our callee’s namespace
(i.e. our root namespace in this case).</p>
<p>Let’s try changing our hostname inside of our container and see
whether we have different hostnames inside and outside:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> hostname <span class="ex">container</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> hostname</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">container</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> hostname</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">torben-xps9320</span></span></code></pre></div>
<p>Our shell inside the new uts namespace now has <code>container</code>
as a hostname while our root namespace still has
<code>torben-xps9320</code>.</p>
<p><em>Much success</em></p>
<h3 id="pid-namespace">pid namespace</h3>
<p>1337 h4x052 that we’re we simply substitute <code>--uts</code> with
<code>--pid</code> and once we’re <em>in</em> once again:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="ex">unshare</span> <span class="at">--pid</span> bash</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bash:</span> fork: Cannot allocate memory</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> bash-5.1# <span class="fu">ls</span> <span class="at">-la</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">bash:</span> fork: Cannot allocate memory</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">bash:</span> wait_for: No record of process 19508</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># note: on executing more commands the `19508` PID is printed as a source everytime</span></span></code></pre></div>
<p>Or not, what is going on here?</p>
<p>Let’s have a look at the relevant processes and their namespaces, we
already know that we can do this via the <code>/proc</code> files:</p>
<p>We’ll start with the only pid we have so far:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> stat <span class="ex">/proc/19508</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">stat:</span> cannot statx <span class="st">&#39;/proc/19508&#39;</span>: No such file or directory</span></code></pre></div>
<p>ok, since we don’t know anything so far let’s have a look at the
processes which we know are running</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> echo <span class="va">$PPID</span> <span class="co"># parent process of our shell in the namespace</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">19498</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> echo <span class="va">$$</span> <span class="co"># our bash process inside the namespace</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ex">19499</span></span></code></pre></div>
<p>Note that our <code>bash</code> process isn’t pid 1 despite us
executing <code>bash</code> in a new pid namespace.</p>
<p>To confirm that these are indeed our processes, let’s have a look at
what these processes are.</p>
<p>If you check the <code>/proc/pid/cmdline</code> file you’ll see the
command and arguments for the pid.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> cat <span class="ex">/proc/19498/cmdline</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> unshare <span class="at">--pid</span> bash</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> cat <span class="ex">/proc/19499/cmdline</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span></span></code></pre></div>
<p>We’ve confirmed that these are our processes, <code>bash</code> is
our command executed inside the namespace and <code>sudo</code> (with
<code>unshare --pid bash</code> as arguments) is our parent process.</p>
<blockquote>
<p>notice anything?</p>
</blockquote>
<h4 id="where-is-the-namespace-info-in-proc"><strong>where is the
namespace info in <code>/proc/</code></strong></h4>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="fu">ls</span> <span class="at">-l</span> /proc/19498/ns/ <span class="kw">|</span> <span class="fu">grep</span> pid</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 15:58 pid <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 15:58 pid_for_children <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="fu">ls</span> <span class="at">-s</span> /proc/19499/ns <span class="kw">|</span> <span class="fu">grep</span> pidthe </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:00 pid <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:00 pid_for_children <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026533205</span><span class="pp">]</span></span></code></pre></div>
<p>Note that our <code>bash</code> process has a different namespace for
<code>pid_for_children</code> this means that all children
(e.g. <code>ls</code>) will be spawned with PIDs residing in the new
namespace.</p>
<h4 id="strace-to-the-rescue"><strong>strace to the rescue</strong></h4>
<p>Let’s have a quick look at what <code>unshare</code> and our
comomands are doing (taking <code>ls</code> as an example), this might
provide us with some insight into why our command is failing.</p>
<p>I can recommend reading the full <code>strace</code> log but I’ll
spare you the effort of finding the interesting bits:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> strace <span class="at">--follow-forks</span> unshare ls</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">3807</span> execve<span class="er">(</span><span class="st">&quot;/usr/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffc049120f0 /<span class="pp">*</span> 63 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3807</span> execve<span class="er">(</span><span class="st">&quot;/usr/local/sbin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7fffb1a5bf60 /<span class="pp">*</span> 63 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> <span class="at">-1</span> ENOENT <span class="er">(</span><span class="ex">No</span> such file or directory<span class="kw">)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">3807</span> execve<span class="er">(</span><span class="st">&quot;/usr/local/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7fffb1a5bf60 /<span class="pp">*</span> 63 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> <span class="at">-1</span> ENOENT <span class="er">(</span><span class="ex">No</span> such file or directory<span class="kw">)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">3807</span> execve<span class="er">(</span><span class="st">&quot;/usr/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffff9934e20 /<span class="pp">*</span> 63 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> 0</span></code></pre></div>
<h4 id="why-are-you-showing-me-some-execve-calls">why are you showing me
some execve calls</h4>
<p>Well, what’s so interesting about <code>execve</code> and what is it?
Let’s steal content from the man-pages again:</p>
<pre class="text"><code>execve()  executes  the  program  referred  to by pathname.  This causes the program that is currently being run by the calling process to be replaced with a new program, with newly initialized stack, heap, and (initialized and uninitialized) data segments.</code></pre>
<p><code>execve</code> is a fairly common syscall, the interesting part
is that <code>execve</code> simply replaces the current process.</p>
<p>For our <code>unshare</code> call this means that the
<code>unshare</code> command “disappears” and <code>ls</code> “appears”
in it’s place with a lot of the same metadata (details on this
later).</p>
<p>I’ve sprinkled the <code>--follow-forks</code> in there so that we
can see that we keep our previous pid when we switch from
<code>unshare</code> to <code>ls</code>.</p>
<h4 id="back-to-debugging">back to debugging</h4>
<p>contrasting this with grep’ing for <code>execve</code> in
<code>ls</code> we see that the <code>execve</code> calls further down
the road do not happen with <code>1s</code>.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> strace <span class="at">--trace</span><span class="op">=</span>execve ls</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">execve</span><span class="er">(</span><span class="st">&quot;/usr/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffd1237b0f0 /<span class="pp">*</span> 63 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span></code></pre></div>
<p>Let’s have a look at the <code>execve</code> man page and check
whether namespaces are mentioned (spoiler, they are not).</p>
<p>But, we do have a section which shows us a list of non-presered
attributes:</p>
<pre class="text"><code>  Effect on process attributes
       All process attributes are preserved during an execve(), except the following:</code></pre>
<p>Since namespaces aren’t explicitly mentioned here we simply assume
that the namespaces info is preserved after <code>execve</code> (in our
<code>ls</code> command).</p>
<h4 id="reading-the-help-usually-helps"><strong>reading the help
usually… helps</strong></h4>
<p>if we have a look at the <code>unshare</code> help the following
option jumps out:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--help</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">-f,</span> <span class="at">--fork</span>                fork before launching <span class="op">&lt;</span>program<span class="op">&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span></code></pre></div>
<p>By now we’re experienced in reading and stealing from man pages so we
have a quick refresher on what fork is:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fork()</span> <span class="ex">This</span>  function  creates  a new process. The return value is the zero in the child and the process-id number of the child in the parent, or <span class="at">-1</span> upon error. In the latter case, ERRNO indicates the problem. In the child, PROCINFO<span class="pp">[</span><span class="st">&quot;pid&quot;</span><span class="pp">]</span> and PROCINFO<span class="pp">[</span><span class="st">&quot;ppid&quot;</span><span class="pp">]</span> are updated to reflect the correct values.</span></code></pre></div>
<p>Since there are no pesky details about with data/attributes is and
isn’t preserved we assume that fork actually spawns a completely new
process with no connection to our callee except (sorta) the PPID.</p>
<h4 id="lets-get-on-with-frking">let’s get on with f*rking</h4>
<p>This is what you’ve all been waiting for</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> unshare <span class="ex">--pid</span> <span class="at">--fork</span> bash</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ls <span class="ex">-l</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[correct</span> output <span class="at">-</span><span class="op">&gt;</span> can allocate memory]</span></code></pre></div>
<p><em>much success</em></p>
<p>Let’s have a look at the difference in our processes</p>
<blockquote>
<p>Reminder: previously we had a parent process (<code>sudo</code> with
<code>unshare --pid bash</code> as arguments which had <code>bash</code>
as a child process)</p>
</blockquote>
<blockquote>
<p>the <code>-e</code> flag for <code>ps</code> is
<code>Select all processes.  Identical to -A.</code></p>
<p>the <code>-f</code> flag is
<code>-f     Do full-format listing.  This option can be combined with many other UNIX-style options to add additional columns.  It also causes the command arguments to be printed.  When used with -L, the NLWP (number of threads) and LWP (thread ID) columns will be added. See the c option, the format keyword args, and the format keyword comm.</code></p>
</blockquote>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> ps <span class="ex">-ef</span> <span class="kw">|</span> <span class="fu">grep</span> bash</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>       21109    6984  0 16:20 pts/2    00:00:00 sudo unshare <span class="at">--pid</span> <span class="at">--fork</span> bash</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>       21110   21109  0 16:20 pts/2    00:00:00 unshare <span class="at">--pid</span> <span class="at">--fork</span> bash</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>       21111   21110  0 16:20 pts/2    00:00:00 bash</span></code></pre></div>
<p>instead of <code>sudo</code> being the <code>pid</code>, we now have
a separate <code>unshare</code> process which is the parent of our
<code>bash</code> process (this makes sense since <code>bash</code> is
started as a forked process).</p>
<p>Looking at the namespaces we also observe something interesting</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="fu">ls</span> <span class="at">-l</span> /proc/21109/ns/ <span class="kw">|</span> <span class="fu">grep</span> pid</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:23 pid <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:23 pid_for_children <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="fu">ls</span> <span class="at">-l</span> /proc/21110/ns/ <span class="kw">|</span> <span class="fu">grep</span> pid</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:24 pid <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026531836</span><span class="pp">]</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:24 pid_for_children <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026533086</span><span class="pp">]</span> <span class="co"># (!) 06 not 36</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="fu">ls</span> <span class="at">-l</span> /proc/21111/ns/ <span class="kw">|</span> <span class="fu">grep</span> pid</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:24 pid <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026533086</span><span class="pp">]</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span> 1 root root 0 10. Mai 16:24 pid_for_children <span class="at">-</span><span class="op">&gt;</span> pid:<span class="pp">[</span><span class="ss">4026533086</span><span class="pp">]</span></span></code></pre></div>
<p>Previously our <code>bash</code> namespace had it’s own pid inside of
our root namespace, whereas now the <code>bash</code> process is in our
new namespace and <code>unshare</code> has it’s pid in the root
namespace while <code>pid_for_children</code> is set to the new
namespace. This makes sense since, otherwise <code>bash</code> wouldn’t
have been started in our new namespace otherwise.</p>
<p><code>bash</code> also has <code>pid_for_children</code> in the new
namepace (as before), so any children will also be executed in the new
namespace. The difference now is that the children have a parent process
in the same pid namespace as before.</p>
<p>This is also be seen by looking at our pid (remember: before our
<code>bash</code> process had a pid != 1)</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> echo <span class="va">$$</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span></span></code></pre></div>
<p>Since we’ve started bash in our new namespace as the root process,
bash now has pid 1.</p>
<h4 id="execve-vs-fork"><strong>execve vs fork</strong></h4>
<p>comparing syscalls for both versions:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> strace <span class="at">--follow-forks</span> unshare <span class="at">--pid</span> ls</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ex">3878</span>  unshare<span class="er">(</span><span class="ex">CLONE_NEWPID</span><span class="kw">)</span>             <span class="ex">=</span> 0</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3878</span>  execve<span class="er">(</span><span class="st">&quot;/usr/local/sbin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffcfb0251b8 /<span class="pp">*</span> 27 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> <span class="at">-1</span> ENOENT <span class="er">(</span><span class="ex">No</span> such file or directory<span class="kw">)</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">3878</span>  execve<span class="er">(</span><span class="st">&quot;/usr/local/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffcfb0251b8 /<span class="pp">*</span> 27 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> <span class="at">-1</span> ENOENT <span class="er">(</span><span class="ex">No</span> such file or directory<span class="kw">)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">3878</span>  execve<span class="er">(</span><span class="st">&quot;/usr/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffcfb0251b8 /<span class="pp">*</span> 27 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ex">3878</span>  brk<span class="er">(</span><span class="ex">NULL</span><span class="kw">)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span>       </span></code></pre></div>
<p>Here the pid at the start of the line confirms that
<code>unshare</code> simply calls <code>execve</code> immediately while
still being the same process.</p>
<p>In the following trace the <code>unshare</code> command calls
<code>clone</code> (basically <code>fork</code> with fine-grained
controls) and only executes <code>execve</code> after creating a new
process (<code>3805</code> -&gt; <code>3806</code>).</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> strace <span class="at">--follow-forks</span> unshare <span class="at">--pid</span> <span class="at">--fork</span> ls</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="ex">3805</span>  unshare<span class="er">(</span><span class="ex">CLONE_NEWPID</span><span class="kw">)</span>             <span class="ex">=</span> 0</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3805</span>  rt_sigprocmask<span class="er">(</span><span class="ex">SIG_BLOCK,</span> [INT TERM], [], 8<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">3805</span>  clone<span class="er">(</span><span class="va">child_stack</span><span class="op">=</span>NULL, <span class="va">flags</span><span class="op">=</span>CLONE_CHILD_CLEARTID<span class="kw">|</span><span class="ex">CLONE_CHILD_SETTID</span><span class="kw">|</span><span class="ex">SIGCHLD,</span> child_tidptr=0x7f77911a7a10<span class="kw">)</span> <span class="ex">=</span> 3806</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="ex">3805</span>  wait4<span class="er">(</span><span class="ex">3806,</span>  <span class="op">&lt;</span>unfinished ...<span class="op">&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  set_robust_list<span class="er">(</span><span class="ex">0x7f77911a7a20,</span> 24<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  rt_sigprocmask<span class="er">(</span><span class="ex">SIG_SETMASK,</span> [], NULL, 8<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  execve<span class="er">(</span><span class="st">&quot;/usr/local/sbin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffe4e825060 /<span class="pp">*</span> 27 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> <span class="at">-1</span> ENOENT <span class="er">(</span><span class="ex">No</span> such file or directory<span class="kw">)</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  execve<span class="er">(</span><span class="st">&quot;/usr/local/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffe4e825060 /<span class="pp">*</span> 27 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> <span class="at">-1</span> ENOENT <span class="er">(</span><span class="ex">No</span> such file or directory<span class="kw">)</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  execve<span class="er">(</span><span class="st">&quot;/usr/bin/ls&quot;</span><span class="ex">,</span> <span class="pp">[</span><span class="st">&quot;ls&quot;</span><span class="pp">]</span>, 0x7ffe4e825060 /<span class="pp">*</span> 27 vars <span class="pp">*</span>/<span class="kw">)</span> <span class="ex">=</span> 0</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  brk<span class="er">(</span><span class="ex">NULL</span><span class="kw">)</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="ex">3806</span>  +++ exited with 0 +++</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="ex">3805</span>  <span class="op">&lt;</span>... wait4 resumed<span class="op">&gt;</span>[{WIFEXITED<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="kw">&amp;&amp;</span> <span class="ex">WEXITSTATUS</span><span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">==</span> 0}], 0, NULL<span class="kw">)</span> <span class="ex">=</span> 3806</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span></code></pre></div>
<h4 id="why-does-frking-help">**why does f*rking help**</h4>
<p>Commands we execute there (e.g. the <code>ls -la</code>) will have a
parent process in the same namespace (i.e. <code>bash</code>).</p>
<p>Without <code>fork</code> (i.e. with <code>execve</code>), commands
that we execute in our unshared pid namespace would have no parent
process which lives in the same namspace, Linux doesn’t like this
(having a pid namespace without a PID 1) and so we cannot allocate
memory.</p>
<p>From the <code>execve</code> manpage:</p>
<pre class="text"><code>  Effect on process attributes
       All process attributes are preserved during an execve(), except the following:</code></pre>
<p>if you’ve a look at this man page yourself you’ll see that namespaces
aren’t mentioned here -&gt; they are preserved.</p>
<p><code>fork</code> doesn’t mention namespaces explicitly either, but
we know that fork creates a new process and that
<code>pid_for_children</code> is the new namespace for our
<code>unshare</code> process.</p>
<p>excerpt from the <code>pid_namespaces</code> man page:</p>
<pre class="text"><code>If the &quot;init&quot; process of a PID namespace terminates, the kernel terminates all of the processes in the namespace via a SIGKILL signal.  This behavior reflects the fact that the &quot;init&quot; process is  essential for the correct operation of a PID namespace.  In this case, a subsequent fork(2) into this PID namespace fail with the error ENOMEM; it is notv possible to create a new process in a PID namespace whose &quot;init&quot; process has terminated.  Such scenarios can occur when, for example, a process uses an open file descriptor for a /proc/pid/ns/pid file corresponding to a process  that  was  in  a namespace  to  setns(2)  into  that  namespace  after  the &quot;init&quot; process has terminated.  Another possible scenario can occur after a call to unshare(2): if the first child subsequently created by a fork(2) terminates, then subsequent calls to fork(2) fail with ENOMEM.

Only signals for which the &quot;init&quot; process has established a signal handler can be sent to the &quot;init&quot; process by other members of the PID namespace.  This restriction applies even to  privileged  processes, and prevents other members of the PID namespace from accidentally killing the &quot;init&quot; process.</code></pre>
<blockquote>
<p>note the
<code>a subsequent fork(2) into this PID namespace fail with the error ENOMEM</code>.</p>
</blockquote>
<h4 id="todo-rewrite-in-rust"><strong>TODO: rewrite in
rust</strong></h4>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st"> -&gt; </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>getppid<span class="op">(),</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>getpid<span class="op">());</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>compile this c program with a compiler of your choice and let’s
execute this:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo unshare <span class="at">--pid</span> <span class="at">--fork</span> ./a.out</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> <span class="at">-</span><span class="op">&gt;</span> 1 <span class="co"># new namespace</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo unshare <span class="at">--pid</span> ./a.out</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ex">23767</span> <span class="at">-</span><span class="op">&gt;</span> 23768 <span class="co"># old namespace</span></span></code></pre></div>
<h4 id="disappointment"><strong>disappointment</strong></h4>
<p>so, we now know that with <code>--fork</code> we are pid 1 in our new
namespace.</p>
<p>If we have a look at our current processes we should only see the
process which we pass to unshare since this is our PID 1, correct?</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="ex">unshare</span> <span class="at">--pid</span> <span class="at">--fork</span> bash</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./a.out</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span> <span class="at">-</span><span class="op">&gt;</span> 3 <span class="co"># bash is our parent process with PID 1</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ps <span class="ex">-ef</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">UID</span>          PID    PPID  C STIME TTY          TIME CMD</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           1       0  0 14:46 <span class="pp">?</span>        00:00:02 /usr/lib/systemd/systemd <span class="at">--switched-root</span> <span class="at">--system</span> <span class="at">--de</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           2       0  0 14:46 <span class="pp">?</span>        00:00:00 <span class="pp">[</span><span class="ss">kthreadd</span><span class="pp">]</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           3       2  0 14:46 <span class="pp">?</span>        00:00:00 <span class="pp">[</span><span class="ss">rcu_gp</span><span class="pp">]</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           4       2  0 14:46 <span class="pp">?</span>        00:00:00 <span class="pp">[</span><span class="ss">rcu_par_gp</span><span class="pp">]</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span></code></pre></div>
<p>well, <code>ps</code> thinks that <code>systemd</code> is our root
process in this namespace (PID 1).</p>
<p>let’s have a look at what <code>ps</code> is doing to retrieve
processes.</p>
<p><code>strace</code> will become your friend at some point, just trust
me on this.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> strace <span class="ex">--trace=openat</span> ps <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 50</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span> <span class="co"># ps setup</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/sys/kernel/pid_max&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 4</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/sys/kernel/osrelease&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 4</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/meminfo&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 4</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc&quot;</span>, O_RDONLY<span class="kw">|</span><span class="ex">O_NONBLOCK</span><span class="kw">|</span><span class="ex">O_CLOEXEC</span><span class="kw">|</span><span class="ex">O_DIRECTORY</span><span class="kw">)</span> <span class="ex">=</span> 5</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/1/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/1/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/2/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/2/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/3/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/3/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/4/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/4/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/5/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/5/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/6/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/6/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/8/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/8/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/10/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/10/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/12/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/12/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/13/stat&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="ex">openat</span><span class="er">(</span><span class="ex">AT_FDCWD,</span> <span class="st">&quot;/proc/13/status&quot;</span>, O_RDONLY<span class="kw">)</span> <span class="ex">=</span> 6</span></code></pre></div>
<p><code>ps</code> reads from <code>/proc</code>, while we do have a new
pid namespace, we still have the same filesystem (you may’ve noticed
this when doing <code>ls</code> inside and outside of our unshared
namespace).</p>
<p>With our process in another namespace accessing
<code>/proc/$$/*</code> doesn’t work anymore since we’d access the pid
from the root namespace.</p>
<p>note that the <code>/proc/self</code> is still valid:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> unshare <span class="ex">--pid</span> <span class="at">--fork</span> bash</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ls <span class="ex">-l</span> /proc/ <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;self -&gt;&quot;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span>  1 root             root                           0 11. Mai 20:01 self <span class="at">-</span><span class="op">&gt;</span> 23105</span></code></pre></div>
<h3 id="mount-namespace">mount namespace</h3>
<p>Since we know that <code>/proc</code> is just a virtual filesystem
which is conveniently mounted by systemd for us, let’s try to
“overmount” it in a new mount namespace</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> unshare <span class="ex">--pid</span> <span class="at">--fork</span> <span class="at">--mount</span> bash</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ls <span class="ex">/proc/</span> <span class="at">-l</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 5</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 0</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 1</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 10</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 100</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 101</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 102</span></code></pre></div>
<p>This is what we saw before, just our <code>/proc</code> filesystem
from our “parent” namespace</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> mount <span class="ex">-t</span> proc proc /proc</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ls <span class="ex">-l</span> /proc <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 5</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 0</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root root               0 10. Mai 17:26 1</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root root               0 10. Mai 17:26 12</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root root               0 10. Mai 17:26 13</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  4 root root               0 10. Mai 17:26 acpi</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> ls <span class="ex">-l</span> /proc <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 5</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 0</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 1</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 10</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 100</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>  9 root             root                           0 10. Mai 16:46 101</span></code></pre></div>
<p>Similar to the <code>pid</code> and <code>uts</code> namespace we
observe that we now see different files in <code>/proc</code> for
different namespaces after we’ve remounted it.</p>
<p>The “parent” namespace still has the same <code>/proc</code> system
as before.</p>
<p>Checking out the mount information in both namespaces:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="fu">mount</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;/proc type proc&quot;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">proc</span> on /proc type proc <span class="er">(</span><span class="ex">rw,nosuid,nodev,noexec,relatime</span><span class="kw">)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> sudo <span class="fu">mount</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;/proc type proc&quot;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="ex">proc</span> on /proc type proc <span class="er">(</span><span class="ex">rw,nosuid,nodev,noexec,relatime</span><span class="kw">)</span> <span class="co"># root proc</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="ex">proc</span> on /proc type proc <span class="er">(</span><span class="ex">rw,relatime</span><span class="kw">)</span> <span class="co"># our namespaced /proc</span></span></code></pre></div>
<p>We also observe that we don’t lose access to the root mount
namespace, this is because unshare copies the mount list from the
previous mount namespace.</p>
<p><code>unshare</code> has the convenient <code>--mount-proc</code>
argument (implies <code>--mount</code>), when setting this
<code>unshare</code> will setup a new <code>/proc</code> mount for us
before dropping us into the namespace.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--fork</span> <span class="at">--pid</span> <span class="at">--mount-proc</span> ls /proc <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 2</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="ex">acpi</span></span></code></pre></div>
<p><strong>TODO</strong> talk about peer groups (slave, unbindable,
[…])</p>
<h3 id="combining-pid-and-mount">combining pid and mount</h3>
<p>Now that we know how to setup a new <code>/proc</code> mount we can
incorporate this into our pid-namespace to make <code>ps</code> behave
correctly:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sudo <span class="ex">unshare</span> <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> ps <span class="ex">-ef</span> <span class="kw">|</span> <span class="fu">grep</span> bash</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5466    1481  0 20:09 pts/0    00:00:00 sudo unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5467    5466  0 20:09 pts/0    00:00:00 unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5468    5467  0 20:09 pts/0    00:00:00 bash</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ps <span class="ex">-ef</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="ex">UID</span>          PID    PPID  C STIME TTY          TIME CMD</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           1       0  0 13:01 pts/0    00:00:00 bash</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           3       1  0 13:02 pts/0    00:00:00 ps <span class="at">-ef</span></span></code></pre></div>
<h4 id="nesting">nesting</h4>
<p>We’ve done <code>unshare</code> inside of our root namespace up to
now, what happens if we execute <code>unshare</code> inside a new
namespace?</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> sudo <span class="ex">unshare</span> <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> ps <span class="ex">-ef</span> <span class="kw">|</span> <span class="fu">grep</span> bash</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5466    1481  0 20:09 pts/0    00:00:00 sudo unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5467    5466  0 20:09 pts/0    00:00:00 unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5468    5467  0 20:09 pts/0    00:00:00 bash</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5660    5468  0 20:10 pts/0    00:00:00 sudo unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5661    5660  0 20:10 pts/0    00:00:00 unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>        5662    5661  0 20:10 pts/0    00:00:00 bash</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> sudo <span class="ex">unshare</span> <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ps <span class="ex">-ef</span> <span class="co"># by doing nsenter --target {pid of $1/bash} --all ps -ef</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="ex">UID</span>          PID    PPID  C STIME TTY          TIME CMD</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           1       0  0 13:01 pts/0    00:00:00 bash</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           5       1  0 13:04 pts/0    00:00:00 sudo unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           6       5  0 13:04 pts/0    00:00:00 unshare <span class="at">--pid</span> <span class="at">--fork</span> <span class="at">--mount-proc</span> bash</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           7       6  0 13:04 pts/0    00:00:00 bash</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           8       0  0 13:04 pts/1    00:00:00 ps <span class="at">-ef</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="va">$2</span><span class="op">&gt;</span> ps <span class="ex">-ef</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="ex">UID</span>          PID    PPID  C STIME TTY          TIME CMD</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           1       0  0 13:04 pts/0    00:00:00 bash</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span>           2       1  0 13:05 pts/0    00:00:00 ps <span class="at">-ef</span></span></code></pre></div>
<p>Nesting namespaces doesn’t seem to be a problem and behaves as we
could’ve expected (the same as in the root namespace).</p>
<p>There is a limit when nesting user namespaces, the maximum nesting
limit is 32.</p>
<h4 id="checking-all-pids-for-a-process">checking all PIDs for a
process</h4>
<p>Since a process can have several PIDs in several namespaces it might
be handy to see them all, all PIDs for a process can be found in
<code>/proc/pid/status</code></p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> cat <span class="ex">/proc/5468/status</span> <span class="kw">|</span> <span class="fu">grep</span> NSpid</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">NSpid:</span>  5468    1</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> cat <span class="ex">/proc/5662/status</span> <span class="kw">|</span> <span class="fu">grep</span> NSpid</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="ex">NSpid:</span>  5662    7   1</span></code></pre></div>
<p>Nesting PIDs go from left to right
(<code>{root namespace} {ns1} {ns2} [...]</code>)</p>
<p>(block keeps IDs (<code>${id}&gt;</code>) from above)</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> nsenter <span class="ex">--target</span> 5468 <span class="at">--all</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> cat <span class="ex">/proc/7/status</span> <span class="kw">|</span> <span class="fu">grep</span> NSpid</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">NSpid:</span>  7   1</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> cat <span class="ex">/proc/7/cmdline</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="va">$2</span><span class="op">&gt;</span> cat <span class="ex">/proc/1/status</span> <span class="kw">|</span> <span class="fu">grep</span> NSpid</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="ex">NSpid:</span>  1</span></code></pre></div>
<h3 id="ips-namespace">ips namespace</h3>
<p>Quick and dirty, the <code>ips</code> namespace is mostly about
System V features such as shared memory or shared semaphores.</p>
<blockquote>
<p>ipcs shows information on System V inter-process communication
facilities. By default it shows information about all three resources:
shared memory segments, message queues, and semaphore arrays.</p>
</blockquote>
<p>- man-page</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ipcs</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span> Message Queues <span class="at">--------</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="ex">key</span>        msqid      owner      perms      used-bytes   messages</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span> Shared Memory Segments <span class="at">--------</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="ex">key</span>        shmid      owner      perms      bytes      nattch     status</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="ex">0x51300022</span> 3          torben     600        16         1</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0xca040002</span> 4          torben     600        65536      1</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00000000</span> 7          torben     600        69632      2          dest</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span> Semaphore Arrays <span class="at">--------</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="ex">key</span>        semid      owner      perms      nsems</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="ex">0xcc040002</span> 2          torben     600        1</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="ex">0xcb040002</span> 3          torben     600        1</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo unshare <span class="at">--ipc</span> ipcs</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span> Message Queues <span class="at">--------</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="ex">key</span>        msqid      owner      perms      used-bytes   messages</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span> Shared Memory Segments <span class="at">--------</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="ex">key</span>        shmid      owner      perms      bytes      nattch     status</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span> Semaphore Arrays <span class="at">--------</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="ex">key</span>        semid      owner      perms      nsems</span></code></pre></div>
<h3 id="net-namespace">net namespace</h3>
<p>A fairly common want is to separate a process from the network
completely or to limit it in a certain way.</p>
<p>Another point is that, especially when running multiple webservers,
you don’t want to care about which process is running on which port and
whether they might overlap.</p>
<p>Currently, if we try to run two processes which listen on the same
port we get this (<code>python -m http.server</code> (omitted
stacktrace)):</p>
<pre><code>OSError: [Errno 98] Address already in use</code></pre>
<p>Let’s try executing the second server in a new net namespace:</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-m</span> http.server</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Serving</span> HTTP on 0.0.0.0 port 8000 <span class="er">(</span><span class="ex">http://0.0.0.0:8000/</span><span class="kw">)</span> <span class="ex">...</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--net</span> python <span class="at">-m</span> http.server</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Serving</span> HTTP on :: port 8000 <span class="er">(</span><span class="ex">http://[::]:8000/</span><span class="kw">)</span> <span class="ex">...</span></span></code></pre></div>
<p>While this does work, the second serve message seems weird. With the
first we know that we can simply reach it via any address our device
listens on since python serves it on 0.0.0.0.</p>
<p>The second info simply shows us that the python server is listening
on the IPv6 address which is equivalent to IPv4s 0.0.0.0
(<code>::</code> omits <code>0</code> blocks for IPv6 addresses).</p>
<p>Let’s have a quick look at the interfaces for our new namespace:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--net</span> ip a</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1:</span> lo: <span class="op">&lt;</span>LOOPBACK<span class="op">&gt;</span> mtu 65536 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/loopback</span> 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></code></pre></div>
<p>There we have it, we can’t very well listen on an IP if we don’t have
any interfaces.</p>
<p>Creating our namespace</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns add demons</span></code></pre></div>
<p>We’re using a separate command for creating our namespace here since
it’ll make following along a bit easier.</p>
<p>This step isn’t necessary and an alternative is talked about
below.</p>
<h4 id="where-do-the-demons-live"><strong>where do the demons
live</strong></h4>
<div class="sourceCode" id="cb45"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-l</span> /var/run/netns</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">.r--r--r--</span> 0 root 12 Mai 09:23 demons</span></code></pre></div>
<h4 id="setting-up-interfaces"><strong>setting up
interfaces</strong></h4>
<p>First we’re going to set-up a virtual interface with a peer.</p>
<p>We’re gonna name the virtual interfaces <code>veth0</code> for our
host and <code>neth0</code> for the interface which will reside in our
namespace.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link add veth0 type veth peer name neth0</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip a <span class="kw">|</span> <span class="fu">grep</span> neth <span class="at">-A</span> 4</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="ex">5:</span> neth0@veth0: <span class="op">&lt;</span>BROADCAST,MULTICAST,M-DOWN<span class="op">&gt;</span> mtu 1500 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> 42:5f:6d:66:a3:d5 brd ff:ff:ff:ff:ff:ff</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="ex">6:</span> veth0@neth0: <span class="op">&lt;</span>BROADCAST,MULTICAST,M-DOWN<span class="op">&gt;</span> mtu 1500 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> b2:5a:06:5f:cf:9b brd ff:ff:ff:ff:ff:ff</span></code></pre></div>
<blockquote>
<p>Peered interfaces are always displayed as
<code>{name}@{name or if{id}}: [...]</code></p>
</blockquote>
<p>Both interfaces are now in our root namespace, we can assign the
interface to a namespace via the <code>ip</code> command:</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set neth0 netns demons</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip a <span class="kw">|</span> <span class="fu">grep</span> neth</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># no output</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip a <span class="kw">|</span> <span class="fu">grep</span> veth</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="ex">6:</span> veth0@if5: <span class="op">&lt;</span>BROADCAST,MULTICAST<span class="op">&gt;</span> mtu 1500 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> b2:5a:06:5f:cf:9b brd ff:ff:ff:ff:ff:ff link-netns demons</span></code></pre></div>
<h4 id="separating-our-interfaces">separating our interfaces</h4>
<p>We notice that our peer was renamed to <code>if5</code> instead of
<code>neth0</code>, this is simply because interface IDs are globally
unique while names are only unique in namespaces.</p>
<p>With this id you can also track an interface across namespaces.</p>
<p><code>ip netns exec</code> is a shorthand for
<code>nsenter --net=/var/run/netns/{netnsname}</code></p>
<blockquote>
<p>when using <code>unshare --net bash</code> you can also use the net
namespace file at <code>/proc/pid/ns/net</code> (pid=pid for bash in
root namespace)</p>
</blockquote>
<div class="sourceCode" id="cb48"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip a</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1:</span> lo: <span class="op">&lt;</span>LOOPBACK<span class="op">&gt;</span> mtu 65536 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/loopback</span> 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="ex">5:</span> neth0@if6: <span class="op">&lt;</span>BROADCAST,MULTICAST<span class="op">&gt;</span> mtu 1500 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> 42:5f:6d:66:a3:d5 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></code></pre></div>
<div class="sourceCode" id="cb49"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ping 127.0.0.1</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ping:</span> connect: Network is unreachable</span></code></pre></div>
<p>while the namespace did create the <code>lo</code> interface by
itself, we have no <code>NetworkManager</code> (or similar) to manage
this interface.</p>
<p>So we have to bring it up ourselves:</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip link set lo up</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ping 127.0.0.1</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 127.0.0.1 <span class="er">(</span><span class="ex">127.0.0.1</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.014 ms</span></code></pre></div>
<h4 id="everyone-gets-an-ip-address"><strong>everyone gets an IP
address</strong></h4>
<p>Next, we want to connect from one interface to the other, for this to
work we need to assign IPs to our interfaces and bring them up (same as
we did with the <code>lo</code> interface).</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip addr add 172.16.0.2/24 dev veth0</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip a</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="ex">6:</span> veth0@if5: <span class="op">&lt;</span>BROADCAST,MULTICAST<span class="op">&gt;</span> mtu 1500 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> b2:5a:06:5f:cf:9b brd ff:ff:ff:ff:ff:ff link-netns demons</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">inet</span> 172.16.0.2/24 scope global veth0</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip addr add 172.16.0.3/24 dev neth0</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip a</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="ex">5:</span> neth0@if6: <span class="op">&lt;</span>BROADCAST,MULTICAST<span class="op">&gt;</span> mtu 1500 qdisc noop state DOWN group default qlen 1000</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> 42:5f:6d:66:a3:d5 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">inet</span> 172.16.0.2/24 scope global neth0</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set veth0 up</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip link set neth0 up</span></code></pre></div>
<h4 id="talk-to-me-baby"><strong>talk to me baby</strong></h4>
<div class="sourceCode" id="cb52"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 172.16.0.3</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.3 <span class="er">(</span><span class="ex">172.16.0.3</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.3: icmp_seq=1 ttl=64 time=0.119 ms</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ping 172.16.0.2</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.2 <span class="er">(</span><span class="ex">172.16.0.2</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.2: icmp_seq=1 ttl=64 time=0.056 ms</span></code></pre></div>
<h4 id="i-dont-want-to-share-my-database"><strong>I don’t want to share
my database</strong></h4>
<p>Let’s say you’re running your backend and database on the same
server.</p>
<p>While you obviously want to connect to the database with your
backend, you might not want others to be able to do so.</p>
<p>Since we want both processes isolated in their own net namespace, we
need to connect these two namespaces.</p>
<p>First, let’s setup a second namespace (we’ll run our server in our
<code>demons</code> namespace):</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns add database</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link add veth1 type veth peer name neth1</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set neth1 netns database</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec database ip link set lo up</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec database ip link set neth1 up</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set veth1 up</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip addr add 172.16.0.4/24 dev veth1</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec database ip addr add 172.16.0.5/24 dev neth0</span></code></pre></div>
<h4 id="pinging-all-namespaced-interfaces"><strong>pinging all
namespaced interfaces</strong></h4>
<div class="sourceCode" id="cb54"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 172.16.0.3</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.3 <span class="er">(</span><span class="ex">172.16.0.3</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.3: icmp_seq=1 ttl=64 time=0.034 ms</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 172.16.0.5</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.5 <span class="er">(</span><span class="ex">172.16.0.5</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="ex">From</span> 172.16.0.2 icmp_seq=1 Destination Host Unreachable</span></code></pre></div>
<p>so… why can’t we ping the second interface?</p>
<p>Let’s have a quick look at the routing table:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip route</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="ex">default</span> via 192.168.2.1 dev wlan0 proto dhcp src 192.168.2.55 metric 600</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev veth0 proto kernel scope link src 172.16.0.2</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev veth1 proto kernel scope link src 172.16.0.4</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="ex">192.168.2.0/24</span> dev wlan0 proto kernel scope link src 192.168.2.55 metric 600</span></code></pre></div>
<p>we have 2 routes for <code>172.16.0.0/24</code> on 2 different
interfaces, since the first route is always preferred ping tries to
connect to our database IP via the backend IP.</p>
<p>These two can’t talk to each other yet since we don’t have any
connection (e.g. peered interfaces) between them.</p>
<p>We can instruct ping to use a specific interface though via
<code>-I</code>:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.5 <span class="er">(</span><span class="ex">172.16.0.5</span><span class="kw">)</span> <span class="ex">from</span> 172.16.0.4 veth1: 56<span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.5: icmp_seq=1 ttl=64 time=0.057 ms</span></code></pre></div>
<p>this works, so setting up multiple interfaces in different namespaces
is fine as long as we’re careful about how we connect to them.</p>
<p>To let these 2 network interfaces talk to each other, we’ll setup a
bridge:</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link add name br0 type bridge</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip addr add 172.16.0.100/24 brd + dev br0</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set br0 up</span></code></pre></div>
<p>Next we’re going to connect our virtual interfaces to the bridge:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set veth0 master br0</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip link set veth1 master br0</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> bridge link show br</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip a</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># note the br0 v</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="ex">14:</span> veth0@if13: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="op">&gt;</span> mtu 1500 qdisc noqueue master br0 state UP group default qlen 1000</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co"># note the br0 v</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="ex">16:</span> veth1@if15: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="op">&gt;</span> mtu 1500 qdisc noqueue master br0 state UP group default qlen 1000</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="ex">17:</span> br0: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="op">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">link/ether</span> 0e:c3:2f:5d:55:1f brd ff:ff:ff:ff:ff:ff</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">inet</span> 172.16.0.100/24 brd 172.16.0.255 scope global br0</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">inet6</span> fe80::cc3:2fff:fe5d:551f/64 scope link</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span></code></pre></div>
<p>we now have a bridge which is connected to both our veth devices.</p>
<p><strong>TODO</strong>: explicitly show that the ping below doesn’t
work without the bridge</p>
<h4 id="ping-ping-ping"><strong>ping ping ping</strong></h4>
<div class="sourceCode" id="cb59"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec database ping 172.16.0.3</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.3 <span class="er">(</span><span class="ex">172.16.0.3</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.3: icmp_seq=1 ttl=64 time=0.053 ms</span></code></pre></div>
<p>pinging our database interface is still not possible though:</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.5 <span class="er">(</span><span class="ex">172.16.0.5</span><span class="kw">)</span> <span class="ex">from</span> 172.16.0.4 veth1: 56<span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.5: icmp_seq=1 ttl=64 time=0.057 ms</span></code></pre></div>
<p>let’s have a look at our routes again:</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="ex">default</span> via 192.168.2.1 dev wlan0 proto dhcp src 192.168.2.55 metric 600</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev veth0 proto kernel scope link src 172.16.0.2</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev veth1 proto kernel scope link src 172.16.0.4</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev br0 proto kernel scope link src 172.16.0.100</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="ex">192.168.2.0/24</span> dev wlan0 proto kernel scope link src 192.168.2.55 metric 600</span></code></pre></div>
<p>Since the old non-bridge routes are still there, we’re simply going
to delete them:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ip route delete 172.16.0.0/24 dev veth0</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ip route delete 172.16.0.0/24 dev veth1</span></code></pre></div>
<p>and now we’re able to ping both IPs in namespaces connected to the
bridge</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 172.16.0.3</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.3 <span class="er">(</span><span class="ex">172.16.0.3</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.3: icmp_seq=1 ttl=64 time=0.105 ms</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 172.16.0.5</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 172.16.0.5 <span class="er">(</span><span class="ex">172.16.0.5</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 172.16.0.5: icmp_seq=1 ttl=64 time=0.061 ms</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip route</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="ex">default</span> via 192.168.2.1 dev wlan0 proto dhcp src 192.168.2.55 metric 600</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev br0 proto kernel scope link src 172.16.0.100</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="ex">192.168.2.0/24</span> dev wlan0 proto kernel scope link src 192.168.2.55 metric 600 </span></code></pre></div>
<h4 id="let-me-be-your-guide-to-the-internet"><strong>let me be your
guide to the internet</strong></h4>
<p>Since our backend might want to connect to the outside world, we
should check whether this is possible:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo ip netns exec demons ping 1.1</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ping:</span> connect: Network is unreachable</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo ip netns exec demons ip route</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev neth0 proto kernel scope link src 172.16.0.3</span></code></pre></div>
<p>Seems like we can’t connect to the outside world.</p>
<p>When looking at the routing table we observe that we don’t have a
route for <code>1.0.0.1</code>.</p>
<p>We want to add a default route which uses the bridge as the default
gateway since the veth devices are connected to it.</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip route add default 172.16.0.100</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ip route</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="ex">default</span> via 172.16.0.100 dev neth0</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="ex">172.16.0.0/24</span> dev neth0 proto kernel scope link src 172.16.0.3</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 1.1</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 1.1 <span class="er">(</span><span class="ex">1.0.0.1</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[...]</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="ex">^C</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="ex">---</span> 1.1 ping statistics <span class="at">---</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="ex">16</span> packets transmitted, 0 received, 100% packet loss, time 15213ms</span></code></pre></div>
<p>While we can transmit outbound packets, apparently we can’t get any
incoming packages.</p>
<p>Let’s have a quick look at tcpdump:</p>
<p>(the next few code blocks which use tcpdump will use
<code>${id}&gt;</code> to denote different terminals, not
namespaces)</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> tcpdump <span class="ex">-i</span> veth0</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on veth0, link-type EN10MB <span class="er">(</span><span class="ex">Ethernet</span><span class="kw">)</span><span class="ex">,</span> snapshot length 262144 bytes</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="ex">09:05:13.617057</span> IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 58067, seq 1, length 64</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="ex">09:05:14.629357</span> IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 58067, seq 2, length 64</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="ex">09:05:15.642648</span> IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 58067, seq 3, length 64</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> sudo <span class="ex">ip</span> netns exec demons ping 1.1</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 1.1 <span class="er">(</span><span class="ex">1.0.0.1</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="ex">^C</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="ex">---</span> 1.1 ping statistics <span class="at">---</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> packets transmitted, 0 received, 100% packet loss, time 2022ms</span></code></pre></div>
<p>What’re we missing?</p>
<p>Normally we would expect a ICMP reply, checking this on our host:</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> tcpdump <span class="ex">src</span> 1.0.0.1 or dst 1.0.0.1 and icmp</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on wlan0, link-type EN10MB <span class="er">(</span><span class="ex">Ethernet</span><span class="kw">)</span><span class="ex">,</span> snapshot length 262144 bytes</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="ex">09:11:29.138072</span> IP torben-xps9320 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 22, seq 1, length 64</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="ex">09:11:29.188307</span> IP one.one.one.one <span class="op">&gt;</span> torben-xps9320: ICMP echo reply, id 22, seq 1, length 64</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="ex">09:11:30.139337</span> IP torben-xps9320 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 22, seq 2, length 64</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="ex">09:11:30.191649</span> IP one.one.one.one <span class="op">&gt;</span> torben-xps9320: ICMP echo reply, id 22, seq 2, length 64</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="ex">09:11:31.141023</span> IP torben-xps9320 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 22, seq 3, length 64</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="ex">09:11:31.196535</span> IP one.one.one.one <span class="op">&gt;</span> torben-xps9320: ICMP echo reply, id 22, seq 3, length 64</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> ping <span class="ex">1.1</span></span></code></pre></div>
<p>As stated before, the NetworkManager isn’t controlling our new
self-made LAN.</p>
<p>This means that NetworkManager has neither setup any iptable rules
and thus we don’t have a NAT for our LAN.</p>
<p>One way of enabling different LANs on a linux machine to reach out to
the internet is via <code>MASQUERADING</code>, this is basically Linuxs
way to do NAT.</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sysctl <span class="at">-w</span> net.ipv4.ip_forward=1</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> iptables <span class="at">-t</span> nat <span class="at">-A</span> POSTROUTING <span class="at">-s</span> 172.16.0.0/24 <span class="at">-j</span> MASQUERADE</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ip netns exec demons ping 1.1</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 1.1 <span class="er">(</span><span class="ex">1.0.0.1</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 1.0.0.1: icmp_seq=1 ttl=57 time=135 ms</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 1.0.0.1: icmp_seq=2 ttl=57 time=283 ms</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 1.0.0.1: icmp_seq=3 ttl=57 time=52.6 ms</span></code></pre></div>
<blockquote>
<p>note: make sure that the ip_forward value isn’t overriden in
<code>/etc/sysctl.conf</code>, otherwise you’l lose this setting on the
next reboot</p>
</blockquote>
<p>Why the <code>ip_forward=1</code>, per default the kernel rejects any
messages of which the destination IP is not configured on the incoming
interface.</p>
<p>Let’s have a quick look at the tcpdumps for pinging <code>1.1</code>
with <code>ip_forward=0</code> and <code>ip_forward=1</code>:</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sysctl <span class="ex">-w</span> net.ipv4.ip_forward=0</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> ip <span class="ex">netns</span> exec demons ping 1.1</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span> tcpdump <span class="at">-i</span> any src 1.0.0.1 or dst 1.0.0.1 and icmp</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on any, link-type LINUX_SLL2 <span class="er">(</span><span class="ex">Linux</span> cooked v2<span class="kw">)</span><span class="ex">,</span> snapshot length 262144 bytes</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="ex">09:24:43.893068</span> veth0 P   IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 36300, seq 1, length 64</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="ex">09:24:43.893068</span> br0   In  IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 36300, seq 1, length 64</span></code></pre></div>
<p>We see that the “can transmit” has a catch, while we can go out from
our interface, our packet stops on our bridge interface and is rejected
(not visible in the tcpdump) by our default interface
(<code>wlan0</code> currently for me). So <code>ip_forward</code> isn’t
only concerning incoming packets, but outgoing packets as well (since
both are incoming for our default interface).</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> sysctl <span class="ex">-w</span> net.ipv4.ip_forward=1</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="va">$0</span><span class="op">&gt;</span> ip <span class="ex">netns</span> exec demons ping 1.1</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span><span class="op">&gt;</span> tcpdump <span class="ex">-i</span> any src 1.0.0.1 or dst 1.0.0.1 and icmp</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on any, link-type LINUX_SLL2 <span class="er">(</span><span class="ex">Linux</span> cooked v2<span class="kw">)</span><span class="ex">,</span> snapshot length 262144 bytes</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="ex">09:25:08.442557</span> veth0 P   IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 22358, seq 1, length 64</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="ex">09:25:08.442557</span> br0   In  IP 172.16.0.3 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 22358, seq 1, length 64</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="ex">09:25:08.442602</span> wlan0 Out IP torben-xps9320 <span class="op">&gt;</span> one.one.one.one: ICMP echo request, id 22358, seq 1, length 64</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="ex">09:25:08.492767</span> wlan0 In  IP one.one.one.one <span class="op">&gt;</span> torben-xps9320: ICMP echo reply, id 22358, seq 1, length 64</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="ex">09:25:08.492816</span> br0   Out IP one.one.one.one <span class="op">&gt;</span> 172.16.0.3: ICMP echo reply, id 22358, seq 1, length 64</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="ex">09:25:08.492826</span> veth0 Out IP one.one.one.one <span class="op">&gt;</span> 172.16.0.3: ICMP echo reply, id 22358, seq 1, length 64</span></code></pre></div>
<p>With <code>ip_forward=1</code> the tcpdump is pretty much as
expected, our packet travels outbound via <code>veth0</code> -&gt;
<code>br0</code> -&gt; <code>wlan0</code> (default interface) and comes
in on the same route (obviously backwards).</p>
<p>Let’s take a small break from the network namespace and focus on a
different namespace.</p>
<h3 id="user-namespaces">user namespaces</h3>
<div class="sourceCode" id="cb71"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare id</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="va">uid</span><span class="op">=</span>1000<span class="kw">(</span><span class="ex">torben</span><span class="kw">)</span> <span class="va">gid</span><span class="op">=</span>1000<span class="kw">(</span><span class="ex">torben</span><span class="kw">)</span> <span class="va">groups</span><span class="op">=</span>1000<span class="kw">(</span><span class="ex">torben</span><span class="kw">)</span><span class="ex">,3</span><span class="er">(</span><span class="ex">sys</span><span class="kw">)</span><span class="ex">,982</span><span class="er">(</span><span class="ex">rfkill</span><span class="kw">)</span><span class="ex">,998</span><span class="er">(</span><span class="ex">wheel</span><span class="kw">)</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--user</span> id</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="va">uid</span><span class="op">=</span>65534<span class="kw">(</span><span class="ex">nobody</span><span class="kw">)</span> <span class="va">gid</span><span class="op">=</span>65534<span class="kw">(</span><span class="ex">nobody</span><span class="kw">)</span> <span class="va">groups</span><span class="op">=</span>65534<span class="kw">(</span><span class="ex">nobody</span><span class="kw">)</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--user</span> ls <span class="at">-ln</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> 1 65534 65534  41335 15. Mai 12:11 README.md</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unshare <span class="at">--user</span> /bin/ls / <span class="at">-lna</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39; \.$&#39;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxr-xr-x</span>  17 65534 65534  4096 29. Mär 19:53 .</span></code></pre></div>
<p>We observe that all files are now shown as if the user rights were
<code>nobody:nogroup</code>.</p>
<p>When testing this (e.g. by writing to <code>/</code>) we see that
this is not actually true</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> touch /test.txt</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="ex">touch:</span> cannot touch <span class="st">&#39;/test.txt&#39;</span>: Permission denied</span></code></pre></div>
</body>
</html>
